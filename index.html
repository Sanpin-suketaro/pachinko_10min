<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>10秒に合わせろ！ — Flashy 10s Timer Game（パチンコ演出付き）</title>
  <style>
    :root{--bg1:#070412;--neon1:#00f0ff;--neon2:#ff2ec8}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 10% 20%, rgba(0,240,255,0.06), transparent), radial-gradient(1000px 500px at 90% 80%, rgba(255,46,200,0.04), transparent), var(--bg1);font-family:Inter,system-ui,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;color:#fff;overflow:hidden}
    .wrap{height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px}
    .panel{width:min(880px,94vw);padding:26px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.008));box-shadow:0 10px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04);text-align:center}
    .title{font-size:20px;font-weight:700;letter-spacing:1px}
    .timer{font-size:84px;font-weight:800;margin:8px 0;letter-spacing:2px;text-shadow:0 12px 30px rgba(0,240,255,0.08);transition:opacity 0.12s linear, filter 0.12s linear, transform 0.12s linear}
    .sub{opacity:0.8}
    .controls{display:flex;gap:12px;justify-content:center;margin-top:10px}
    button{padding:12px 18px;border-radius:12px;border:none;font-weight:700;cursor:pointer}
    #toggle{background:linear-gradient(90deg,var(--neon1),var(--neon2));color:#07060a}
    #reset{background:rgba(255,255,255,0.06);color:#fff}
    .stats{display:flex;gap:12px;justify-content:center;margin-top:14px}
    .stat{background:rgba(255,255,255,0.02);padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    #hint{font-size:14px;color:rgba(255,255,255,0.72);margin-top:8px}
    #canvas{position:fixed;inset:0;z-index:0;pointer-events:none}
    .overlayUI{position:relative;z-index:2}
    .big-confetti{position:fixed;inset:0;pointer-events:none;z-index:3}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}

    /* パチンコ風光演出 */
    .pachinko-flash {
      position:fixed; inset:0;
      background: radial-gradient(circle at center, rgba(255,255,255,0.9), rgba(255,255,255,0.1), transparent 80%);
      mix-blend-mode:screen;
      z-index:100;
      animation: flash 0.6s ease-out forwards;
    }
    @keyframes flash {
      0%{opacity:0;}
      20%{opacity:1;}
      100%{opacity:0;}
    }

    .pachi-spark {
      position:fixed; width:6px; height:6px;
      background: radial-gradient(circle, #fff, transparent);
      border-radius:50%; pointer-events:none;
      mix-blend-mode:screen; z-index:101;
      animation: spark 0.8s ease-out forwards;
    }
    @keyframes spark {
      from {transform:scale(1) translate(0,0); opacity:1;}
      to {transform:scale(2) translate(var(--tx), var(--ty)); opacity:0;}
    }

    .bigText {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:96px; font-weight:900;
      color:gold; text-shadow:0 0 20px #fff, 0 0 40px #f0f;
      opacity:0; z-index:200;
      animation: showBig 1.2s ease-out forwards;
    }
    @keyframes showBig {
      0%{transform:scale(0.6);opacity:0;}
      40%{transform:scale(1.2);opacity:1;}
      100%{transform:scale(1);opacity:0;}
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div class="wrap overlayUI">
    <div class="panel">
      <div class="title">10秒に合わせろ！</div>
      <div class="timer" id="display">0.000</div>
      <div class="sub">狙え、正確に。スペースキー／ボタンで開始／停止。</div>

      <div class="controls">
        <button id="toggle">Start</button>
        <button id="reset">Reset Best</button>
      </div>

      <div class="stats">
        <div class="stat">ベスト: <strong id="best">-- ms</strong></div>
        <div class="stat">今回の差: <strong id="diff">-- ms</strong></div>
        <div class="stat">スコア: <strong id="score">--</strong></div>
      </div>

      <div id="hint">10秒ぴったりで「パチンコ演出」発動！100ms以内でも光る！</div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let W = canvas.width = innerWidth;
  let H = canvas.height = innerHeight;
  addEventListener('resize', ()=>{W = canvas.width = innerWidth; H = canvas.height = innerHeight;});

  const display = document.getElementById('display');
  const toggleBtn = document.getElementById('toggle');
  const resetBtn = document.getElementById('reset');
  const bestEl = document.getElementById('best');
  const diffEl = document.getElementById('diff');
  const scoreEl = document.getElementById('score');

  const TARGET = 10.0;
  let running = false; let startTime = 0; let raf = null;
  let lastElapsed = 0;

  const AC = new (window.AudioContext || window.webkitAudioContext)();
  async function ensureAudioUnlocked(){ try{ if(AC.state === 'suspended') await AC.resume(); }catch(e){} }

  function playSuccessSound(){
    const now = AC.currentTime;
    const master = AC.createGain(); master.gain.value=0.001; master.connect(AC.destination);
    master.gain.exponentialRampToValueAtTime(0.1, now + 0.01);
    master.gain.exponentialRampToValueAtTime(0.0001, now + 1.2);
    const freqs = [880,1100,1320];
    freqs.forEach((f,i)=>{
      const o=AC.createOscillator();o.type='sine';o.frequency.value=f;
      const g=AC.createGain();g.gain.value=0.0;o.connect(g);g.connect(master);
      const t=now+i*0.1;
      g.gain.linearRampToValueAtTime(0.2,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.6);
      o.start(t);o.stop(t+0.8);
    });
  }

  function clickSound(){
    const o=AC.createOscillator();const g=AC.createGain();
    o.type='sine';o.frequency.value=900;g.gain.value=0.0001;o.connect(g);g.connect(AC.destination);
    const now=AC.currentTime;
    g.gain.exponentialRampToValueAtTime(0.06,now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,now+0.1);
    o.start(now);o.stop(now+0.12);
  }

  // confetti
  const confetti=[];
  function spawnConfetti(n=60){
    for(let i=0;i<n;i++){
      confetti.push({x:Math.random()*W,y:-10,vx:(Math.random()-0.5)*4,vy:Math.random()*3+2,r:Math.random()*6+4,hue:Math.random()*360,rot:Math.random()*6});
    }
  }

  function spawnBurst(x,y,colorHue,n=30){
    for(let i=0;i<n;i++){
      const a=Math.random()*Math.PI*2;const s=Math.random()*6+2;
      confetti.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:Math.random()*4+2,hue:colorHue,rot:0});
    }
  }

  function update(dt){
    for(let i=confetti.length-1;i>=0;i--){
      const c=confetti[i];c.vy+=0.06;c.x+=c.vx;c.y+=c.vy;c.rot+=0.06;
      if(c.y>H+30) confetti.splice(i,1);
    }
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    const g=ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,'rgba(0,0,0,0.25)');
    ctx.fillStyle=g;ctx.fillRect(0,0,W,H);

    const t=performance.now()/1000;
    for(let i=0;i<6;i++){
      ctx.beginPath();const x=(i+1)*W/7+120*Math.sin(t*0.6+i);
      ctx.arc(x,H*0.22+30*Math.cos(t*0.7+i),220,0,Math.PI*2);
      ctx.fillStyle=`hsla(${60*i+140},80%,50%,${0.02+i*0.002})`;ctx.fill();
    }

    for(const c of confetti){
      ctx.save();ctx.translate(c.x,c.y);ctx.rotate(c.rot);
      ctx.fillStyle=`hsl(${c.hue} 80% 60%)`;
      ctx.fillRect(-c.r/2,-c.r/2,c.r,c.r*1.6);
      ctx.restore();
    }
  }

  let last=performance.now();
  function loop(now){
    const dt=now-last;last=now;
    if(running){
      const elapsed=(performance.now()-startTime)/1000;
      lastElapsed=elapsed;
      display.textContent=elapsed.toFixed(3);
      if(elapsed<5){
        const opacity=Math.max(0,1-(elapsed/5));
        display.style.opacity=opacity;
        display.style.filter=`blur(${(1-opacity)*6}px)`;
      } else {
        display.style.opacity=0;display.style.visibility='hidden';
      }
    }
    update(dt);draw();
    raf=requestAnimationFrame(loop);
  }

  function resetDisplayStyle(){
    display.style.opacity=1;display.style.filter='none';display.style.visibility='visible';
  }

  async function start(){
    await ensureAudioUnlocked();
    running=true;toggleBtn.textContent='Stop';resetBtn.disabled=true;
    startTime=performance.now();last=performance.now();
    resetDisplayStyle();clickSound();
  }

  async function stop(){
    if(!running)return;
    running=false;toggleBtn.textContent='Start';resetBtn.disabled=false;
    const elapsed=lastElapsed;display.textContent=elapsed.toFixed(3);resetDisplayStyle();

    const diff=Math.abs(elapsed-TARGET);const ms=diff*1000;
    diffEl.textContent=`${ms.toFixed(0)} ms`;
    const score=Math.max(0,Math.round(10000-ms*12));
    scoreEl.textContent=score;

    let best=localStorage.getItem('flashy10_best_ms');best=best?Number(best):null;
    if(best===null||ms<best){localStorage.setItem('flashy10_best_ms',ms);bestEl.textContent=`${ms.toFixed(0)} ms`; }

    spawnBurst(W/2,H/2,ms<150?160:320,40);

    if(ms<=100){
      playSuccessSound();spawnConfetti(120);
      triggerPachinkoEffect();
    } else clickSound();
  }

  // 既存の triggerPachinkoEffect を差し替え
  function triggerPachinkoEffect(ms) {
    const isPerfect = ms <= 10;

    // 金色の背景
    const bg = document.createElement('div');
    bg.style.position = 'fixed';
    bg.style.inset = 0;
    bg.style.background = 'radial-gradient(circle at center, gold, #ffec8a, #b8860b)';
    bg.style.zIndex = 90;
    bg.style.animation = `bgFlash ${isPerfect ? 5 : 3}s linear forwards`;
    document.body.appendChild(bg);
    setTimeout(() => bg.remove(), (isPerfect ? 5000 : 3000));

    // 虹色テキスト
    const big = document.createElement('div');
    big.className = 'bigText';
    big.style.animation = `rainbowText ${isPerfect ? 5 : 3}s linear infinite`;
    big.textContent = isPerfect ? '確定！！' : '10.000!! PERFECT!!';
    document.body.appendChild(big);
    setTimeout(() => big.remove(), (isPerfect ? 5000 : 3000));

    // パチンコの光とスパーク（継続）
    const duration = isPerfect ? 5000 : 3000;
    const sparkCount = isPerfect ? 200 : 80;

    const interval = setInterval(() => {
      for (let i = 0; i < sparkCount / 10; i++) {
        const s = document.createElement('div');
        s.className = 'pachi-spark';
        const tx = (Math.random() - 0.5) * (isPerfect ? 1000 : 600);
        const ty = (Math.random() - 0.5) * (isPerfect ? 700 : 400);
        s.style.setProperty('--tx', `${tx}px`);
        s.style.setProperty('--ty', `${ty}px`);
        s.style.left = `${W / 2}px`;
        s.style.top = `${H / 2}px`;
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 800);
      }

      // 10ms以内ならランダムに「確定！」文字を大量追加
      if (isPerfect) {
        const txt = document.createElement('div');
        txt.textContent = ['確定！', '超激アツ！', '大当り！', 'ド派手！', '連チャン！'][Math.floor(Math.random() * 5)];
        txt.style.position = 'fixed';
        txt.style.left = `${Math.random() * W}px`;
        txt.style.top = `${Math.random() * H}px`;
        txt.style.fontSize = `${40 + Math.random() * 60}px`;
        txt.style.fontWeight = '900';
        txt.style.color = `hsl(${Math.random() * 360},100%,70%)`;
        txt.style.textShadow = '0 0 10px #fff, 0 0 20px #f0f';
        txt.style.transform = `rotate(${(Math.random() - 0.5) * 40}deg)`;
        txt.style.opacity = 0;
        txt.style.transition = 'opacity 0.3s ease-out';
        document.body.appendChild(txt);
        requestAnimationFrame(() => (txt.style.opacity = 1));
        setTimeout(() => txt.remove(), 1200);
      }
    }, 200);

    setTimeout(() => clearInterval(interval), duration);
  }

  // 新しいCSSアニメーションを追加
  const style = document.createElement('style');
  style.textContent = `
  @keyframes rainbowText {
    0% { color: red; }
    15% { color: orange; }
    30% { color: yellow; }
    45% { color: green; }
    60% { color: cyan; }
    75% { color: blue; }
    90% { color: magenta; }
    100% { color: red; }
  }
  @keyframes bgFlash {
    0%,100% { opacity: 0; }
    10%,90% { opacity: 1; }
  }
  `;
  document.head.appendChild(style);


  toggleBtn.addEventListener('click',()=>{!running?start():stop();});
  resetBtn.addEventListener('click',()=>{localStorage.removeItem('flashy10_best_ms');bestEl.textContent='--';diffEl.textContent='-- ms';scoreEl.textContent='--';});
  addEventListener('keydown',(e)=>{
    if(e.code==='Space'){e.preventDefault();!running?start():stop();}
  });

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
